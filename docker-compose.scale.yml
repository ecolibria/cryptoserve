# Docker Compose for Horizontal Scaling
# Usage: docker compose -f docker-compose.scale.yml up --scale backend=3
#
# This configuration demonstrates:
# - Multiple backend instances behind nginx load balancer
# - Redis for distributed rate limiting
# - PostgreSQL with connection pooling
# - Health checks for all services
# - Graceful shutdown handling

services:
  # Load Balancer
  nginx:
    image: nginx:alpine
    ports:
      - "8003:80"
    volumes:
      - ./nginx.scale.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Backend API (scale with: --scale backend=N)
  backend:
    build: ./backend
    environment:
      # Database
      DATABASE_URL: postgresql+asyncpg://cryptoserve:localdev@postgres:5432/cryptoserve
      DB_POOL_SIZE: 5
      DB_MAX_OVERFLOW: 10
      DB_POOL_RECYCLE: 1800

      # Redis for distributed rate limiting
      REDIS_URL: redis://redis:6379/0

      # Security (use strong values in production!)
      CRYPTOSERVE_MASTER_KEY: ${CRYPTOSERVE_MASTER_KEY:-dev-master-key-change-in-production}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-jwt-secret-change-in-production}
      HKDF_SALT: ${HKDF_SALT:-cryptoserve-v1-change-in-production}

      # OAuth
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}

      # URLs (nginx handles external traffic)
      FRONTEND_URL: http://localhost:3003
      BACKEND_URL: http://localhost:8003

      # Environment
      ENVIRONMENT: production
      DEV_MODE: "false"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    command: >
      uvicorn app.main:app
      --host 0.0.0.0
      --port 8003
      --workers 1
      --timeout-graceful-shutdown 30
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: cryptoserve
      POSTGRES_USER: cryptoserve
      POSTGRES_PASSWORD: localdev
      # Performance tuning for multiple connections
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=768MB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cryptoserve"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis for distributed rate limiting and caching
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Frontend (optional, can be served separately)
  frontend:
    build: ./frontend
    ports:
      - "3003:3000"
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8003
      API_URL: http://nginx:80
    depends_on:
      - nginx

volumes:
  postgres_data:
  redis_data:
